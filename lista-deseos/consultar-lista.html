<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Consultar lista</title>
    <link rel="stylesheet" href="librerias/materialize.min.css" />
    <link rel="stylesheet" href="librerias/material-icons.css" />
    <style>
      .hide {
        display: none;
      }
      body {
        background: white;
        font-family: Arial, sans-serif;
      }
      .margin-top-40 {
        margin-top: 40px;
      }
      .margin-bottom-40 {
        margin-bottom: 40px;
      }
      .card-title {
        font-weight: bold !important;
      }
      /* Gen√©ricos */
      .width-100 {
        width: 100%;
      }
      .padding-20 {
        padding: 20px !important;
      }
      .radius-15 {
        border-radius: 15px !important;
      }
      .fuente-32 {
        font-size: 32px;
      }
      .fuente-24 {
        font-size: 24px;
      }
      .no-margin {
        margin: 0 !important;
      }
      .margin-top-10 {
        margin-top: 10px !important;
      }
      .margin-bottom-10 {
        margin-bottom: 10px !important;
      }
      .translate-y-7 {
        transform: translateY(7px);
      }
      /* Media Queries */
      @media (max-width: 993px) {
        #wrapper_inicio {
          width: 100% !important;
        }
      }
      /* Index */
      #wrapper_fondo {
        background: url("img/fondo-regalos.jpg");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        bottom: 0;
        height: 100%;
        left: 0;
        position: absolute;
        top: 0;
        width: 100%;
      }
      #wrapper_inicio {
        background: rgba(0, 0, 0, 0.2);
        bottom: 0;
        height: 100%;
        right: 0;
        position: absolute;
        top: 0;
        width: 50%;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }
      #wrapper_inicio #wrapper_formulario_inicial {
        background: rgba(255, 255, 255, 0.5) !important;
      }
      #nombre_lista {
        border-bottom: 1px solid black;
        box-shadow: none !important;
      }
    </style>
  </head>
  <body>
    <div id="wrapper_fondo"></div>
    <div id="wrapper_inicio" class="valign-wrapper">
      <div class="width-100 padding-20">
        <div class="row">
          <div
            id="wrapper_formulario_inicial"
            class="col s12 padding-20 radius-15"
          >
            <h1 class="center no-margin fuente-32">
              ¬°Crea tu lista de REGALOS!
            </h1>
            <div
              class="divider grey lighten-4 margin-top-10 margin-bottom-10"
            ></div>
            <h2 class="center no-margin fuente-24">Aqu√≠ podr√°s:</h2>
            <ul>
              <li>
                <i class="material-icons translate-y-7">keyboard_arrow_right</i
                >Crear listas de regalos sobre cualquier tema.
              </li>
              <li>
                <i class="material-icons translate-y-7">keyboard_arrow_right</i
                >Compartir tus listas de regalos con tus amigos o conocidos.
              </li>
              <li>
                <i class="material-icons translate-y-7">keyboard_arrow_right</i
                >Permitir que tus amigos o conocidos reserven productos de tus
                listas.
              </li>
            </ul>
            <div
              class="divider grey lighten-4 margin-top-10 margin-bottom-10"
            ></div>
            <form id="crearLista">
              <div class="input-field col s12">
                <i class="material-icons prefix blue-text">sell</i>
                <input id="nombre_lista" type="text" required />
                <label for="nombre_lista" class="black-text"
                  >Nombre de la lista</label
                >
                <span class="helper-text"
                  >*Todas las listas son p√∫blicas, evita colocar datos
                  sensibles.</span
                >
              </div>
              <div class="col s12 center">
                <button
                  class="btn-large black white-text radius-15"
                  type="submit"
                >
                  <b>Crear lista <i class="material-icons right">add</i></b>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <script src="librerias/materialize.min.js"></script>
    <script src="librerias/sweetalert2@11.js"></script>
    <script>
      alert("Validar par√°metros");
      const params = new URLSearchParams(window.location.search);
      // const permisos = params.get("permisos") == 1 ? true : false;

      // üîê Tu proxy seguro (no incluye ninguna key)
      const proxyUrl =
        "https://nextjs-delta-jet-xojigpy6ij.vercel.app/api/prueba"; // c√°mbialo por tu URL real de Vercel

      const form = document.getElementById("crearLista");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (document.getElementById("nombre_lista").value.trim() == "") {
          Swal.fire({
            title: "Necesitas escribir un nombre para tu lista",
            text: "Int√©ntalo de nuevo.",
            icon: "error",
            confirmButtonText: "Cerrar",
          });
        } else {
          const nuevaLista = {
            nombre: document.getElementById("nombre_lista").value,
            productos: [],
          };

          // Leer productos actuales
          const leer = await fetch(proxyUrl);
          const data = await leer.json();
          const listas = data.record.listas || [];

          // Agregar el nuevo
          nuevaLista.id = listas.length + 1;
          nuevaLista.fecha_creacion = new Date().toLocaleString();
          listas.push(nuevaLista);

          // Guardar en JSONbin a trav√©s del proxy
          var response = await fetch(proxyUrl, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ listas }),
          });

          if (response.ok) {
            //Alerta de confirmaci√≥n
            Swal.fire({
              title: "Lista creada con √©xito",
              icon: "success",
              confirmButtonText: "Aceptar",
            }).then(function () {
              window.location.href = "?lista=" + nuevaLista.id;
            });
          } else {
            //Alerta de confirmaci√≥n
            Swal.fire({
              title: "No se ha podido crear la lista",
              text: "Intent√°lo de nuevo.",
              icon: "error",
              confirmButtonText: "Aceptar",
            });
          }
        }
      });
    </script>
  </body>
</html>

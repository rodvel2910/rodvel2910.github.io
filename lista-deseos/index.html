<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lista de deseos</title>
    <style>
      .hide {
        display: none;
      }
      body {
        background: #f1f1f1;
        font-family: Arial, sans-serif;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: center;
      }
      th {
        background-color: #f2f2f2;
      }
      input[type="text"] {
        width: 80%;
        padding: 4px;
      }
      button {
        padding: 6px 10px;
        cursor: pointer;
      }
      .center {
        text-align: center;
      }
      #productoForm label {
        font-weight: bold;
      }
      #productoForm input {
        width: 100%;
        padding: 10px;
        border-radius: 15px;
        border: 1px solid #333;
      }
      #productoForm button {
        border-radius: 15px;
        padding: 15px;
        background: #333;
        color: white;
        font-weight: bold;
        border: none;
      }
    </style>
  </head>
  <body>
    <form id="productoForm" class="hide">
      <div>
        <p><label>Item: </label></p>
        <input type="text" id="nombre" required />
      </div>
      <div>
        <p class="center"><button type="submit">Agregar producto</button></p>
      </div>
    </form>

    <h1>Listado para el Casa Shower</h1>
    <table id="tablaProductos">
      <thead>
        <tr>
          <th>Item</th>
          <th>Disponibilidad</th>
          <th>Persona</th>
          <th>Fecha reserva</th>
          <th>Reservar</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <script>
      const params = new URLSearchParams(window.location.search);
      const permisos = params.get("permisos") == 1 ? true : false;

      // ðŸ” Tu proxy seguro (no incluye ninguna key)
      const proxyUrl =
        "https://nextjs-delta-jet-xojigpy6ij.vercel.app/api/jsonbin"; // cÃ¡mbialo por tu URL real de Vercel

      if (permisos) {
        const form = document.getElementById("productoForm");
        form.classList.remove("hide");

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const nuevoProducto = {
            nombre: document.getElementById("nombre").value,
            estado: "Disponible",
            persona: "",
            fecha: "",
          };

          // Leer productos actuales
          const leer = await fetch(proxyUrl);
          const data = await leer.json();
          const productos = data.record.productos || [];

          // Agregar el nuevo
          productos.push(nuevoProducto);

          // Guardar en JSONbin a travÃ©s del proxy
          await fetch(proxyUrl, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ productos }),
          });

          form.reset();
          cargarProductos();
        });
      }

      cargarProductos();

      async function cargarProductos() {
        const res = await fetch(proxyUrl);
        const data = await res.json();
        const productos = data.record.productos || [];
        mostrarProductos(productos);
      }

      function mostrarProductos(productos) {
        const tbody = document.querySelector("#tablaProductos tbody");
        tbody.innerHTML = "";

        productos.forEach((p, index) => {
          var fecha = p.fecha ? new Date(p.fecha).toLocaleString() : "N/A";
          const fila = document.createElement("tr");
          fila.innerHTML = `
            <td>${p.nombre}</td>
            <td>${p.estado}</td>
            <td>${p.persona || "N/A"}</td>
            <td>${fecha}</td>
            <td>
              ${
                p.estado === "Disponible"
                  ? `
                    <input type="text" placeholder="Tu nombre" id="persona-${index}">
                    <button onclick="reservar(${index})">Reservar</button>
                  `
                  : `<em>Reservado</em>`
              }
            </td>
          `;
          tbody.appendChild(fila);
        });
      }

      async function reservar(indice) {
        const input = document.getElementById(`persona-${indice}`);
        const nombre = input.value.trim();
        if (!nombre)
          return alert("Por favor, ingresa tu nombre para reservar.");

        const res = await fetch(proxyUrl);
        const data = await res.json();
        const productos = data.record.productos;

        productos[indice].estado = "Reservado";
        productos[indice].persona = nombre;
        productos[indice].fecha = new Date().toISOString();

        await fetch(proxyUrl, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ productos }),
        });

        alert(`âœ… ${productos[indice].nombre} reservado por ${nombre}`);
        cargarProductos();
      }
    </script>
  </body>
</html>
